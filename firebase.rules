rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
  	match /users/{document}{
    	allow read, write;
    }
    match /threadId/{document}{
    	allow read, write;
    }
    match /threads/{document} {
        allow write:  if request.auth != null && canEdit();
        allow read: if request.auth != null && canInteract();
    }
    function canEdit(){
    		let validDate = request.resource.data.createdAt == request.time && request.resource.data.latestMessage == request.time;
        let isInMembers = request.auth.uid in request.resource.data.members;
        let hadFeilds = request.resource.data.keys().hasAll(['members', 'groupName', 'createdAt', 'messages', 'latestMessage']);
        return isInMembers && validDate && hadFeilds;
    }

    function canInteract(){
      let isInDocument = request.auth.uid in get(request.path).data.members;

      return isInDocument;
    }
  }
}